#!/bin/bash


# VARS

# [] && false || true
# [!] && true || false

# check vhost name
[[ $1 ]] && SITE=$1 || echo "falta vhost name"
[[ $1 ]] && SITE=$1 || exit

# check installation type
[[ $2 ]] && INSTALL=$2

#print options
echo -e "\n\n==========================\n==========================";
[[ $SITE ]] && echo -e "==> SITE: $SITE";
[[ $INSTALL ]] && echo -e "==> INSTALL: $INSTALL\n==========================";
echo -e "==========================\n==========================\n\n";
# set vars
CONF_SITES_AVAILABLE="/etc/apache2/sites-available/${SITE}.conf"
CONF_SITES_ENABLED="/etc/apache2/sites-enabled/${SITE}.conf"
CONF_SITE_FOLDER="/mnt/c/wsl/sites/${SITE}/"






#FUNCTIONS

# create folder
function newfolder(){
    if [[ -d ${CONF_SITE_FOLDER} ]]; then
        echo -e "==> Existe la ruta, continuando."
    else
        echo -e "No existe la ruta, creándola..."
        mkdir -p ${CONF_SITE_FOLDER}
        mkdir -p ${CONF_SITE_FOLDER}/web
        mkdir -p ${CONF_SITE_FOLDER}/log
        sudo chmod -R 777 ${CONF_SITE_FOLDER}
    fi
    
}

# create vhost
function newvhost(){
    if [[ $SITE ]]; then #comprueba si existe la ruta
        
        if [ -f ${CONF_SITES_AVAILABLE} ]; then
            echo -e "\n${CONF_SITES_AVAILABLE} exists."
        else
            echo -e "\nCONF_SITES_AVAILABLE ${CONF_SITES_AVAILABLE} does not exist."
            echo -e "\nCreating...."
            sudo rm ${CONF_SITES_AVAILABLE} 2>/dev/null
            sudo touch ${CONF_SITES_AVAILABLE} 2>/dev/null
            
            sudo echo "
<VirtualHost *:8888>
    ServerName ${SITE}
    ServerAdmin webmaster@${SITE}.test
    DocumentRoot ${CONF_SITE_FOLDER}/web
    RewriteEngine On
    RewriteOptions inherit
    CustomLog ${CONF_SITE_FOLDER}/log/${SITE}.log combined
</VirtualHost>
            " | sudo tee --append ${CONF_SITES_AVAILABLE}
            sudo a2ensite ${SITE}.conf
            sudo service apache2 reload
            sudo service apache2 restart
        fi
    fi
}
# install_drupal
function install_drupal(){
    echo -e "\n\n==> Instalando Drupal"
}
# drupal install
function install_selector(){
    if [ ${INSTALL} ]; then
        echo -e "\n\n==> Buscando instalaciones disponibles...."
        
        case ${INSTALL} in
            drupal)
                install_drupal;
            ;;
            *)
                echo -e "\n\n==> desconozco esa opción"
            ;;
        esac
    fi
}

# final message
function finalmessage(){
    echo -e "\n\n=====> add 127.0.0.1 ${SITE} to hosts file & flush dns \(recommended http://www.abelhadigital.com/hostsman/\)"
    echo -e "=====> http://${SITE}:8888/user"
}









# LOGIC
sudo service mysql start *>/dev/null
sudo service apache2 start *>/dev/null

newfolder;
newvhost;
install_selector;
finalmessage;
