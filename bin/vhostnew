#!/bin/bash
sudo rm -fr mnt testing /etc/apache2/sites*/testing*
# VARS
# [] && false || true
# [!] && true || false

# check vhost name
[[ $1 ]] && SITE=$1 || echo "falta vhost name"
[[ $1 ]] && SITE=$1 || exit

# check installation type
[[ $2 ]] && INSTALL=$2

# set vars
SITES_FOLDER="/mnt/c/wsl/sites"
CONF_SITES_AVAILABLE="/etc/apache2/sites-available/${SITE}.conf"
CONF_SITES_ENABLED="/etc/apache2/sites-enabled/${SITE}.conf"
CONF_SITE_FOLDER="${SITES_FOLDER}/${SITE}"

#print options
echo -e "\n\n==============================================================\n==============================================================\n";
[[ $SITE ]] && echo -e "==> SITE: $SITE";
[[ $INSTALL ]] && echo -e "\n==> INSTALL: $INSTALL";
echo -e "\n==============================================================\n==============================================================\n\n";





#FUNCTIONS

# create folder
function newfolder(){
    echo -e "\n\n==============================================================\n==============================================================";
    if [[ -d ${CONF_SITE_FOLDER} ]]; then
        echo -e "Paso 1 ==> Existe la ruta, continuando."
    else
        echo -e "Paso 1 ==> No existe la ruta, creandola..."
        mkdir -p ${CONF_SITE_FOLDER}
        mkdir -p ${CONF_SITE_FOLDER}/web
        mkdir -p ${CONF_SITE_FOLDER}/log
        sudo chmod -R 777 ${CONF_SITE_FOLDER}
    fi
    echo -e "==============================================================";
    
}

# create vhost
function newvhost(){
    if [[ $SITE ]]; then #comprueba si existe la ruta
        
        if [ -f ${CONF_SITES_AVAILABLE} ]; then
            echo -e "Paso 2 ==> Existe la configuracion \n${CONF_SITES_AVAILABLE}, continuando."
        else
            echo -e "Paso 2 ==> No existe la configuracion \n${CONF_SITES_AVAILABLE}, creandola..."
            sudo rm ${CONF_SITES_AVAILABLE} 2>/dev/null
            sudo touch ${CONF_SITES_AVAILABLE} 2>/dev/null
            
            sudo echo "
<VirtualHost *:8888>
    ServerName ${SITE}
    ServerAdmin webmaster@${SITE}.test
    DocumentRoot ${CONF_SITE_FOLDER}/web
    RewriteEngine On
    RewriteOptions inherit
    CustomLog ${CONF_SITE_FOLDER}/log/${SITE}.log combined
</VirtualHost>
            " | sudo tee --append ${CONF_SITES_AVAILABLE}
            sudo a2ensite ${SITE}.conf
            sudo service apache2 reload
            sudo service apache2 restart
        fi
        echo -e "==============================================================";
    fi
}

# install_drupal
function install_drupal(){
    echo -e "\n==> Instalando Drupal:\n"
    cd ${CONF_SITE_FOLDER}
    if [[ ! -d "web/sites/default/settings.php" ]]; then
        echo -e "==> Creando drupal"
        drush -y dl drupal --drupal-project-rename="web"
    else
        echo -e "==> Existe una isntalación activa, bórrala manualmente para usar este script"
    fi
    echo -e "==============================================================";
}

# install_selector
function install_selector(){
    if [ ${INSTALL} ]; then
        echo -e "Paso 3 ==> Buscando instalaciones disponibles...."
        
        case ${INSTALL} in
            drupal)
                install_drupal;
            ;;
            *)
                echo -e "Paso 3 ==> opcion incorrecta"
            ;;
        esac
    fi
    echo -e "==============================================================";
}

# final message
function finalmessage(){
    echo -e "\n\n==============================================================\n==============================================================\n";
    echo -e "\n==> add 127.0.0.1 ${SITE} to hosts file & flush dns\n (recommended http://www.abelhadigital.com/hostsman/\)"
    echo -e "\n==> http://${SITE}:8888/user\n"
    echo -e "\n\n==============================================================\n==============================================================\n";
}





# LOGIC
sudo service mysql start *>/dev/null
sudo service apache2 start *>/dev/null
newfolder;
newvhost;
install_selector;
finalmessage;
