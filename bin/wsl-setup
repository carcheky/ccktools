#!/bin/bash

########
# INFO #
########


##########
# CONFIG #
##########


#############
# FUNCTIONS #
#############

set_wslconf() {
  if [[ -f /etc/wsl.conf ]]; then
    echo "==> /etc/wsl.conf encontrado"
    WSLCONFIG=TRUE
    return
  fi
  if [[ ! -f /etc/wsl.conf ]]; then
    echo "==> Creando /etc/wsl.conf y saliendo"
    wget https://raw.githubusercontent.com/carcheky/ccktools/master/config/wsl.conf
    sudo mv -f wsl.conf /etc/
    echo "==> La consola se cerrará, ábrala y vuelva a ejecutar la misma operación"
    read a
    sudo killall -r '.*'
  fi
}

set_dirs() {
  if [[ -d /c/wsl/ ]]; then
    echo "==> Existe la ruta /c/wsl"
    return
  fi
  if [[ ! -d /c/wsl/ ]]; then
    sudo mkdir '/c/wsl/'
    sudo mkdir '/c/wsl/sites'
    sudo mkdir '/c/wsl/user'
    sudo chown -R user:user '/c/wsl/'
    cd '/c/wsl/user'
    git clone https://github.com/carcheky/ccktools.git
  fi
}

update_repo() {
  if [[ -d ~/ccktools ]]; then
    cd ~/ccktools/
    if git pull
      then
        echo "ccktools updated"
      else
        echo "ccktools update failed"
    fi
  fi
}

create_links() {
  if [[ -d /c/wsl/user/ccktools ]]; then
    
    sudo ln -s /c/wsl/user/ccktools/bin  ~
    sudo ln -s /c/wsl/user/ccktools  ~

    if ! grep -q "source ~/ccktools/.ccktools" ~/.bashrc ; then
      echo "source ~/ccktools/.ccktools" >> ~/.bashrc
    fi

    if ! grep -q "source ~/ccktools/.ccktools" ~/.zshrc ; then
      echo "source ~/ccktools/.ccktools" >> ~/.zshrc
    fi

    sudo apt install dos2unix -y 2>/dev/null
    
    find ~/bin/ -type f -exec chmod +x {} \;
    find ~/bin/ -type f -exec dos2unix {} \;
  fi
}

zsh_install(){
    sudo apt update
    sudo apt install git -y
    sudo apt install npm -y
    sudo apt install zsh zsh-doc zsh-common -y
    
    sudo sh -c "$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"

    # sed -i 's/ZSH_THEME="robbyrussell"/ZSH_THEME="agnoster"/g' ~/.zshrc ;

    # cat ~/.zshrc | grep ZSH_THEME=\" ;

    if ! grep -q "bash -c -l zsh" ~/.bashrc ; then
        echo "bash -c -l zsh" >> ~/.bashrc 
    fi
}

lamp_install(){
  echo "=> in work"
    
  sudo apt install -y apache2 php
  sudo debconf-set-selections <<< 'mysql-server mysql-server/root_password password root'
  sudo debconf-set-selections <<< 'mysql-server mysql-server/root_password_again password root'
  sudo apt install -y mysql-server

  sudo service apache2 stop & sudo service mysql stop


  sudo chmod -R /var/cache/debconf

  sudo APP_PASS="root"
  sudo ROOT_PASS="root"
  sudo APP_DB_PASS="root"

  sudo apt clean
  sudo apt autoclean
  sudo dpkg --configure -a
  sudo apt autoremove

  echo "install heidisql to mysql gui"
}

################
# MAIN PROGRAM #
################

rm -fr .wget-hsts
sudo dpkg --configure -a

# echo "=> actualizando fuentes..." 
# sudo apt update 2>/dev/null

# echo "=> actualizando paquetes..." 
# sudo apt upgrade -y 2>/dev/null

set_wslconf

if $WSLCONFIG 
then

  echo "quieres instalar los scripts personalizados? (y/n)"
  read WSL_SETDIRS
  if $WSL_SETDIRS = 'y' 
  then
    echo "=> wsl setdirs"
    set_dirs
    create_links
  fi


  echo "quieres instalar zsh? (y/n)"
  read WSL_ZSH
  if $WSL_ZSH = 'y'
  then
    zsh_install
  fi

  echo "quieres instalar lamp? (y/n)"
  read WSL_LAMP
  if $WSL_LAMP = 'y'
  then
    lamp_install
  fi   


fi