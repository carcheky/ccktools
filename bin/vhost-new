#!/bin/bash
# functions

# [] && false || true
# [!] && true || false

[[ $1 ]] && SITE=$1 || echo "falta vhost name"
[[ $1 ]] && SITE=$1 || exit
[[ $2 ]] && INSTALL=$2
[[ $SITE ]] && echo "==> SITE: $SITE"
[[ $INSTALL ]] && echo "==> INSTALL: $INSTALL"

# Site to add
if [[ $SITE ]]; then
  CONF_SITES_AVAILABLE="/etc/apache2/sites-available/${SITE}.conf"
  CONF_SITES_ENABLED="/etc/apache2/sites-enabled/${SITE}.conf"
  CONF_SITE_FOLDER="/c/wsl/sites/${SITE}/docroot"
  CONF_LOG_FOLDER="/c/wsl/log/"

  if [ -f ${CONF_SITES_AVAILABLE} ]; then
    echo "==> ${CONF_SITES_AVAILABLE} exists."
  else
    echo "==> CONF_SITES_AVAILABLE ${CONF_SITES_AVAILABLE} does not exist."
    echo "==> Creating...."
    sudo touch ${CONF_SITES_AVAILABLE}
    sudo echo "
    <VirtualHost *:80>
        ServerName ${SITE}
        ServerAdmin webmaster@${SITE}.test
        DocumentRoot ${CONF_SITE_FOLDER}
        RewriteEngine On
        RewriteOptions inherit
        CustomLog ${CONF_LOG_FOLDER}/${SITE}.log combined
    </VirtualHost>
    " | sudo tee --append ${CONF_SITES_AVAILABLE}
  fi

  if [ -d ${CONF_SITE_FOLDER} ]; then
    echo "==> folder ${CONF_SITE_FOLDER} exists."
  else
    echo "==> folder ${CONF_SITE_FOLDER} does not exist."
    echo "==> Creating...."
    mkdir -p ${CONF_SITE_FOLDER}
    mkdir -p ${CONF_LOG_FOLDER}
    touch ${CONF_LOG_FOLDER}/alumnice.log
  fi

  if [ -f ${CONF_SITES_ENABLED} ]; then
    echo "==> enabled conf ${CONF_SITES_ENABLED} exists."

  else
    echo "==> enabled ${CONF_SITES_ENABLED} does not exist."
    echo "==> Enabling...."
    sudo a2ensite ${SITE}.conf
  fi

  sudo service apache2 reload
  sudo service apache2 restart
  if [[ $INSTALL ]]; then

    DRUSH=$(which drush)

    if [[ $INSTALL='drupal' ]]; then
      echo "==> installing drupal"
      cd "/c/wsl/sites"
      # cd ${CONF_SITE_FOLDER}
      # sudo chmod -R 777 .
      # cd ..
      # sudo rm -fr docroot
      composer create-project drupal-composer/drupal-project:8.x-dev ${SITE} --no-interaction
      # $DRUSH dl drupal -v
      # mv drup* docroot
      # cd docroot
      cd "${SITE}/web"
      cp sites/default/default.settings.php sites/default/settings.php
      sudo mkdir -p sites/default/files/translations
      sudo chmod -R 777 .
      composer install
      $DRUSH -yv si standard --db-url=mysql://root:root@localhost/${SITE} --site-name=${SITE} --site-mail=test@test.test --account-mail=test@test.test --account-pass=admin --locale=es
      composer require drupal/adminimal_admin_toolbar
      composer require drupal/backup_migrate
      composer require drupal/toolbar_menu_clean
      composer require drupal/config_direct_save
      composer require drupal/pathauto
      $DRUSH en -y locale
      $DRUSH en -y adminimal_admin_toolbar
      $DRUSH en -y backup_migrate
      $DRUSH en -y config_direct_save
      $DRUSH en -y pathauto
      $DRUSH en -y toolbar_menu_clean
      $DRUSH locale-check
      $DRUSH locale-update
      cd ..
      sudo chmod -R 777 .
    fi
  fi

  ls -la ${CONF_SITES_ENABLED}
  ls -la ${CONF_SITE_FOLDER}

  echo "add 127.0.0.1 ${SITE} to hosts file & flush dns (recommended http://www.abelhadigital.com/hostsman/)"
  echo "=====> http://${SITE}/user"
fi
