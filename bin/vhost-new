#!/bin/bash

[[ ! -z "$1" ]] && echo "Not empty" || exit
[[ -z "$2" ]] && INSTALL="drupal"

# Site to add
SITE=$1

CONF_SITES_AVAILABLE="/etc/apache2/sites-available/${SITE}.conf"
CONF_SITES_ENABLED="/etc/apache2/sites-enabled/${SITE}.conf"
CONF_SITE_FOLDER="/c/wsl/sites/${SITE}/docroot"
CONF_LOG_FOLDER="/c/wsl/log/"

if [ -f ${CONF_SITES_AVAILABLE} ]; then
  echo "==> ${CONF_SITES_AVAILABLE} exists."
else
  echo "==> CONF_SITES_AVAILABLE ${CONF_SITES_AVAILABLE} does not exist."
  echo "==> Creating...."
  sudo touch  ${CONF_SITES_AVAILABLE}
  sudo echo "
  <VirtualHost *:80>
      ServerName ${SITE}
      ServerAdmin webmaster@${SITE}.test
      DocumentRoot ${CONF_SITE_FOLDER}
      RewriteEngine On
      RewriteOptions inherit
      CustomLog ${CONF_LOG_FOLDER}/${SITE}.log combined
  </VirtualHost>
  " | sudo tee --append ${CONF_SITES_AVAILABLE}
fi

if [ -d ${CONF_SITE_FOLDER} ]; then
  echo "==> folder ${CONF_SITE_FOLDER} exists."
else
  echo "==> folder ${CONF_SITE_FOLDER} does not exist."
  echo "==> Creating...."
  mkdir -p ${CONF_SITE_FOLDER}
  mkdir -p ${CONF_LOG_FOLDER}
  touch ${CONF_LOG_FOLDER}/alumnice.log
fi

if [ -f ${CONF_SITES_ENABLED} ]; then
   echo "==> enabled conf ${CONF_SITES_ENABLED} exists."

else
  echo "==> enabled ${CONF_SITES_ENABLED} does not exist."
  echo "==> Enabling...."
  sudo a2ensite ${SITE}.conf
fi

sudo service apache2 reload
sudo service apache2 restart

DRUSH=$(which drush)

if [[ $2='drupal' ]]; then
  echo "==> installing drupal"
  cd ${CONF_SITE_FOLDER}
  sudo chmod -R 777 .
  cd ..
  sudo rm -fr docroot
  $DRUSH dl drupal -v
  mv drup* docroot
  cd docroot
  cp sites/default/default.settings.php sites/default/settings.php
  sudo mkdir -p sites/default/files/translations
  sudo chmod -R 777 .
  composer install
  $DRUSH -yv si standard --db-url=mysql://root:root@localhost/${SITE} --site-name=${SITE} --site-mail=test@test.test --account-mail=test@test.test --account-pass=admin  --locale=es
  crequire adminimal_admin_toolbar
  cd ..
  sudo chmod -R 777 .
fi

ls -la ${CONF_SITES_ENABLED}
ls -la ${CONF_SITE_FOLDER}


echo "add 127.0.0.1 ${SITE} to hosts file & flush dns (recommended http://www.abelhadigital.com/hostsman/)"
echo "=====> http://${SITE}/user"
